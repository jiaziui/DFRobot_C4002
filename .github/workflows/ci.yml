---
name: Arduino Library CI

on: 
  push:
    branches:
      - "**"       # ÊôÆÈÄöÂàÜÊîØÊé®ÈÄÅÊó∂ËøêË°å‰ª£Á†ÅÊ£ÄÊü•
    tags:
      - "v*.*.*"   # Â∞èÂÜô v Ëß¶Âèë
      - "V*.*.*"   # Â§ßÂÜô V Ëß¶Âèë
  pull_request:
  repository_dispatch:

permissions:
  contents: read

env:
  PYTHON_3: "3.11.13"
  REQUIREMENTS_PATH: './.github/config/requirements.txt' ## ‰æùËµñÊñá‰ª∂Ë∑ØÂæÑ

jobs:
  common:                                       ## Ëøô‰∏™jobÂøÖÈ°ªÊîæÂú®ÊúÄÂâçÈù¢ÔºåÂõ†‰∏∫ÂÆÉ‰ºöËÆæÁΩÆ‰∏Ä‰∫õÁéØÂ¢ÉÂèòÈáè‰æõÂêéÁª≠job‰ΩøÁî®
    name: Create common environment
    runs-on: ubuntu-24.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }} ## ËæìÂá∫ÁºìÂ≠ò keyÔºå‰æõÂêéÁª≠ job ‰ΩøÁî®
    steps:
      - name: Check out code from GitHub        ## ÊãâÂèñ‰ª£Á†ÅÂà∞ËôöÊãüÊú∫
        uses: actions/checkout@v5.0.0

      - name: Generate cache-key                ## Ê†πÊçÆ‰æùËµñÊñá‰ª∂ÁîüÊàêÁºìÂ≠ò key
        id: cache-key
        run: |
          echo key="${{ hashFiles(env.REQUIREMENTS_PATH, '.pre-commit-config.yaml') }}" >> $GITHUB_OUTPUT

      - name: set up Python ${{ env.PYTHON_3 }} ## ËÆæÁΩÆ Python 3 ÁéØÂ¢É
        id: python3
        uses: actions/setup-python@v6.0.0
        with:
          python-version: ${{ env.PYTHON_3 }}

      - name: Cache venv                        ## ÁºìÂ≠òËôöÊãüÁéØÂ¢É
        id: cache-venv
        uses: actions/cache@v4.2.4
        with:
          path: venv                            ## ÁºìÂ≠òË∑ØÂæÑ
          key: ${{ runner.os }}-${{ env.PYTHON_3 }}-venv-${{ steps.cache-key.outputs.key }}

      - name: Create Python virtual environment ## ÂàõÂª∫ Python ËôöÊãüÁéØÂ¢É
        run: |
          python -m venv venv
          . venv/bin/activate
          pip install -r ${{ env.REQUIREMENTS_PATH }}

      - name: Save venv to cache
        if: steps.cache-venv.outputs.cache-hit != 'true'
        uses: actions/cache@v4.2.4
        with:
          path: venv
          key: ${{ runner.os }}-${{ env.PYTHON_3 }}-venv-${{ steps.cache-key.outputs.key }}

  pylint:
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/'))
      || github.event_name == 'pull_request'
      || github.event_name == 'repository_dispatch'

    runs-on: ubuntu-24.04
    permissions:
      checks: write        
      contents: read 

    continue-on-error: true
    needs:
      - common                      ## ‰æùËµñ common jobÔºåÁ°Æ‰øùÁéØÂ¢ÉÂèòÈáèÂ∑≤ËÆæÁΩÆ
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v5.0.0           ##Ê£ÄÊü•‰ª£Á†Å
    
      - name: Restore Python 3                ## ËøòÂéü Python 3 ÁéØÂ¢É
        uses: ./.github/actions
        with:
          python-version: ${{ env.PYTHON_3 }}
          cache-key: ${{ needs.common.outputs.cache-key }}

      - name: Run pylint
        if: always()
        shell: bash {0}   # ÂéªÊéâÈªòËÆ§ÁöÑ -e
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          . venv/bin/activate

          FILES=$(find . -type f -name "*.py" -not -path "*/.venv/*" -not -path "*/venv/*" -not -path "*/.git/*")

          if [ -z "$FILES" ]; then
            echo "No Python files found. Skipping pylint."
            exit 0
          fi
          set +e
          pylint  -f parseable --rcfile=./.github/config/.pylintrc --persistent=n $FILES

          PYLINT_EXIT=$?
          echo "Pylint exit code: $PYLINT_EXIT"

          if [ $PYLINT_EXIT -eq 0 ]; then
            echo "‚úÖ Pylint passed"
            exit 0
          elif [ $PYLINT_EXIT -eq 20 ]; then
            echo "‚ö†Ô∏è Pylint found errors or warnings"
            curl --silent --show-error --location \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -X POST https://api.github.com/repos/$GITHUB_REPOSITORY/check-runs \
            --data-binary @- >/dev/null 2>&1 <<EOF
          {
            "name": "Pylint Check",
            "head_sha": "$GITHUB_SHA",
            "status": "completed",
            "conclusion": "neutral",
            "completed_at": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "output": {
              "title": "Pylint check warnings",
              "summary": "‚ö†Ô∏è Â≠òÂú®Ë≠¶ÂëäÔºåËØ∑ÁÇπÂáªÂ∑¶‰æßÂØºËà™Ê†è [pylint] ---->>> [Run pylint] Êü•ÁúãË≠¶ÂëäÊó•Âøó„ÄÇ",
              "text": "### ËØ¥Êòé\nÊú¨Ê¨°ÊûÑÂª∫Â≠òÂú® Pylint Ë≠¶ÂëäÔºåËØ¶ÁªÜËæìÂá∫Â∑≤Âú® Actions Êó•Âøó‰∏≠Â±ïÁ§∫„ÄÇ"
            }
          }
          EOF

            else
              echo "‚ùå Pylint failed"
              exit $PYLINT_EXIT
            fi


      - name: Show neutral status

        run: |
          echo "ok"

        if: always()

  clang-tidy:
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/'))
      || github.event_name == 'pull_request'
      || github.event_name == 'repository_dispatch'

    name: check clang-tidy and build
    runs-on: ubuntu-24.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    needs:
      - common
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Restore Python 3
        uses: ./.github/actions
        with:
          python-version: ${{ env.PYTHON_3 }}
          cache-key: ${{ needs.common.outputs.cache-key }}
        

      - name: Install PlatformIO
        run: | 
          pip install platformio
          cp ./.github/config/platformio.ini .

      - name: Generate compile_commands.json
        run: pio run -t compiledb

      - name: Run clang-tidy
        run: |
          FILES=$(find . \
          -path './.git'    -prune -o \
          -path './.github' -prune -o \
          -type f \( -name '*.cpp' -o -name '*.h' -o -name '*.ino' \) -print)
          
          

          echo "Running clang-tidy on $FILES" 
          if [ -z "$FILES" ]; then             # Ê£ÄÊü•ÊòØÂê¶ÊúâÊñá‰ª∂
              echo "No source files found."
              exit 0
          fi

          OUTPUT=$(clang-tidy $FILES -p . \
          -header-filter="$filter" \
          -config-file=./.github/config/.clang-tidy \
          2>&1 || true)

          echo "$OUTPUT"

          # Ê£ÄÊü•ÊòØÂê¶Êúâ error
          if echo "‚ùå $OUTPUT" | grep -q "error:"; then
            echo "::error::clang-tidy found errors."
            exit 1
          elif echo "$OUTPUT" | grep -q "warning:"; then
            echo "‚ö†Ô∏è clang-tidy found warnings."
            curl --silent --show-error --location \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -X POST https://api.github.com/repos/$GITHUB_REPOSITORY/check-runs \
            --data-binary @- <<EOF
          {
            "name": "Clang-Tidy Check",
            "head_sha": "$GITHUB_SHA",
            "status": "completed",
            "conclusion": "neutral",
            "completed_at": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "details_url": "https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID",
            "output": {
              "title": "Clang-Tidy Ê£ÄÊü•ÁªìÊûú",
              "summary": "Errors: $ERRORS, Warnings: $WARNINGS",
              "text": "ËØ¶ÁªÜËæìÂá∫ËøáÈïøÔºåËØ∑Êü•Áúã Actions Êó•Âøó„ÄÇ"
            }
          }
          EOF
          
        if: always()

  release:
      name: Check tag version
      if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/V')
      runs-on: ubuntu-24.04
      permissions:
        contents: write
      needs: common
      concurrency:
        group: release-${{ github.ref }}
        cancel-in-progress: true
      steps:
        - name: Checkout code
          uses: actions/checkout@v5.0.0
          with:
            fetch-depth: 0

        - name: Verify library.properties version
          id: verify
          run: |
            RAW_TAG="${GITHUB_REF#refs/tags/}"      # ‰æãÂ¶Ç v1.0.1 Êàñ V1.0.1
            TAG_VERSION="${RAW_TAG#[vV]}"           # ÂéªÊéâÂâçÂØº v Êàñ V -> 1.0.1

            # ËØªÂèñÂπ∂Ê∏ÖÁêÜÊñá‰ª∂ÈáåÁöÑ version= ÂÄº
            if [ ! -f library.properties ]; then
              echo "‚ùå library.properties not found"
              exit 1
            fi
            FILE_VERSION="$(awk -F= '/^[[:space:]]*version[[:space:]]*=/ {print $2; exit}' library.properties \
              | tr -d '\r' | xargs)"
            echo "üì¶ Tag version: $TAG_VERSION"
            echo "üßæ File version: $FILE_VERSION"

            if [ "$TAG_VERSION" != "$FILE_VERSION" ]; then
              echo "‚ùå Version mismatch!"
              echo "library.properties version ($FILE_VERSION) does not match tag ($TAG_VERSION)"
              exit 1
            fi

            echo "‚úÖ Version match confirmed: $TAG_VERSION"
            echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT

        # - name: Create release zip
        #   id: zip
        #   run: |
        #     ZIP_NAME="${{ github.event.repository.name }}_${{ steps.verify.outputs.tag_version }}.zip"
        #     echo "Creating $ZIP_NAME"
        #     zip -r "$ZIP_NAME" . \
        #       -x '*.git*' '.github/*' '__pycache__/*' # ÊéíÈô§‰∏çÂøÖË¶ÅÁöÑÊñá‰ª∂ .github  „ÄÅ.git  „ÄÅ__pycache__
        #     echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

        # - name: Upload GitHub Release
        #   uses: softprops/action-gh-release@v2
        #   with:
        #     files: ${{ steps.zip.outputs.zip_name }}
        #     generate_release_notes: true
        #   env:
        #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ci-status:
    runs-on: ubuntu-24.04
    needs:
      - common
      - pylint
      - clang-tidy
      - release
    if: always()
    steps:
      - name: Print job results
        run: |
          echo "==== CI Summary ===="
          echo "common:     ${{ needs.common.result }}"
          echo "pylint:     ${{ needs.pylint.result }}"
          echo "clang-tidy: ${{ needs['clang-tidy'].result }}"
          echo "release:    ${{ needs.release.result }}"
          echo "===================="

